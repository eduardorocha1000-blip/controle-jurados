<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">
</head>
<body>
    <!-- Cabe√ßalho -->
    <header class="header-custom">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="/images/logo-tjsc.png" alt="Logo TJSC" class="header-logo me-3">
                    <div>
                        <h1 class="header-title">Controle de Jurados</h1>
                        <p class="header-subtitle">Comarca de Capivari de Baixo</p>
                    </div>
                </div>
                <% if (typeof user !== 'undefined' && user) { %>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        üë§ <%= user.nome %>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="/perfil">‚öôÔ∏è Perfil</a></li>
                        <% if (user.perfil === 'Administrador') { %>
                        <li><a class="dropdown-item" href="/usuarios">üë• Usu√°rios</a></li>
                        <% } %>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="/login/logout" method="POST" class="d-inline">
                                <button type="submit" class="dropdown-item">üö™ Sair</button>
                            </form>
                        </li>
                    </ul>
                </div>
                <% } %>
            </div>
        </div>
    </header>

    <div class="main-container">
        <% if (typeof user !== 'undefined' && user) { %>
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="p-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'dashboard' ? 'active' : '' %>" href="/dashboard">
                            üìä Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'juizes' ? 'active' : '' %>" href="/juizes">
                            ‚öñÔ∏è Ju√≠zes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'instituicoes' ? 'active' : '' %>" href="/instituicoes">
                            üè¢ Institui√ß√µes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'jurados' ? 'active' : '' %>" href="/jurados">
                            üë• Jurados
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'indicacoes' ? 'active' : '' %>" href="/indicacoes">
                            üìã Indica√ß√µes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'sorteios' ? 'active' : '' %>" href="/sorteios">
                            üé≤ Sorteios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'ultimo-conselho' ? 'active' : '' %>" href="/ultimo-conselho">
                            üôã √öltimo Conselho
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'cedulas' ? 'active' : '' %>" href="/cedulas">
                            üé´ C√©dulas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'editais' ? 'active' : '' %>" href="/editais">
                            üìÑ Editais
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'emails' ? 'active' : '' %>" href="/emails">
                            üìß E-mails
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'relatorios' ? 'active' : '' %>" href="/relatorios">
                            üìä Relat√≥rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'backup' ? 'active' : '' %>" href="/backup">
                            üíæ Backup
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <% } %>

        <!-- Conte√∫do Principal -->
        <main class="main-content">
            <% if (typeof messages !== 'undefined' && messages) { %>
                <% if (messages.success && messages.success.length > 0) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    ‚úÖ <%= messages.success[0] %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>
                <% if (messages.error && messages.error.length > 0) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    ‚ùå <%= messages.error[0] %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>
            <% } %>

            <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle btn-icon"></i><%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% } %>

            <div class="container-fluid">
                <!-- Cabe√ßalho -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2><%= typeof edital !== 'undefined' && edital.id ? 'Editar Edital' : 'Novo Edital' %></h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"></h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="<%= typeof action !== 'undefined' ? action : '/editais' %>">
                                    <% if (typeof edital !== 'undefined' && edital && edital.id) { %>
                                    <input type="hidden" name="_method" value="PUT">
                                    <% } %>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="ano_referencia" class="form-label">Ano de Refer√™ncia *</label>
                                            <input type="number" class="form-control" id="ano_referencia" name="ano_referencia" 
                                                   value="<%= typeof edital !== 'undefined' && edital ? edital.ano_referencia : new Date().getFullYear() + 1 %>" 
                                                   min="2020" max="2030" required>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="numero" class="form-label">N√∫mero do Edital</label>
                                            <input type="text" class="form-control" id="numero" name="numero" 
                                                   value="<%= typeof edital !== 'undefined' && edital ? edital.numero : '' %>">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="titulo" class="form-label">T√≠tulo do Edital *</label>
                                            <input type="text" class="form-control" id="titulo" name="titulo" 
                                                   value="<%= typeof edital !== 'undefined' && edital && edital.titulo ? edital.titulo : 'EDITAL DE ALISTAMENTO DE JURADOS PARA O ANO ' + (typeof edital !== 'undefined' && edital && edital.ano_referencia ? edital.ano_referencia : new Date().getFullYear() + 1) + ' DA COMARCA DE CAPIVARI DE BAIXO/SC' %>" required>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="juiz_id" class="form-label">Juiz Respons√°vel</label>
                                            <select class="form-select" id="juiz_id" name="juiz_id">
                                                <option value="">Selecione um juiz...</option>
                                                <% if (typeof juizes !== 'undefined' && juizes) { %>
                                                    <% 
                                                        let juizTitularId = null;
                                                        juizes.forEach(juiz => {
                                                            if (juiz.titular === 'Sim') {
                                                                juizTitularId = juiz.id;
                                                            }
                                                        });
                                                    %>
                                                    <% juizes.forEach(juiz => { %>
                                                        <option value="<%= juiz.id %>" 
                                                                <%= typeof edital !== 'undefined' && edital && edital.juiz_id == juiz.id ? 'selected' : (typeof edital === 'undefined' || !edital || !edital.juiz_id) && juiz.id == juizTitularId ? 'selected' : '' %>>
                                                            <%= juiz.nome_completo %>
                                                        </option>
                                                    <% }) %>
                                                <% } %>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="status" class="form-label">Status *</label>
                                            <select class="form-select" id="status" name="status" required>
                                                <option value="Rascunho" <%= typeof edital !== 'undefined' && edital && edital.status === 'Rascunho' ? 'selected' : '' %>>Rascunho</option>
                                                <option value="Publicado" <%= typeof edital !== 'undefined' && edital && edital.status === 'Publicado' ? 'selected' : '' %>>Publicado</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="data_publicacao_prevista" class="form-label">Data de Publica√ß√£o Prevista</label>
                                            <input type="date" class="form-control" id="data_publicacao_prevista" name="data_publicacao_prevista" 
                                                   value="<%= typeof edital !== 'undefined' && edital && edital.data_publicacao_prevista ? edital.data_publicacao_prevista : (function(){ const y=new Date().getFullYear(); return y+'-10-10'; })() %>">
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="data_publicacao_real" class="form-label">Data de Publica√ß√£o Real</label>
                                            <input type="date" class="form-control" id="data_publicacao_real" name="data_publicacao_real" 
                                                   value="<%= typeof edital !== 'undefined' && edital && edital.data_publicacao_real ? edital.data_publicacao_real : (function(){ const y=new Date().getFullYear(); return y+'-11-10'; })() %>">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="corpo_rtf" class="form-label mb-0">Conte√∫do do Edital (RTF)</label>
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="btn-atualizar-texto">
                                                    üîÑ Substituir os Campos do Texto
                                                </button>
                                            </div>
                                            <textarea class="form-control" id="corpo_rtf" name="corpo_rtf" rows="15" style="text-align: justify;"><%= typeof edital !== 'undefined' && edital ? edital.corpo_rtf : '' %></textarea>
                                            <div class="form-text">
                                                <small class="text-muted">
                                                    üí° Clique em "Atualizar Texto" para substituir os placeholders pelos valores dos campos acima. A lista de jurados ser√° substitu√≠da por uma lista de nomes e profiss√µes em ordem alfab√©tica, um jurado por linha.
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="observacoes" class="form-label">Observa√ß√µes</label>
                                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"><%= typeof edital !== 'undefined' && edital ? edital.observacoes : '' %></textarea>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-save">üíæ</button>
                                        <a href="/editais" class="btn btn-back" title="Voltar">‚¨ÖÔ∏è</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Informa√ß√µes</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6>Importante:</h6>
                                    <ul class="mb-0">
                                        <li>Campos marcados com * s√£o obrigat√≥rios</li>
                                        <li>N√∫mero do edital deve ser √∫nico</li>
                                        <li>Conte√∫do RTF ser√° usado para impress√£o</li>
                                        <li>Data de vencimento deve ser posterior √† publica√ß√£o</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Rodap√© -->
    <footer class="footer-custom">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">Total de Jurados: <span id="total-jurados">-</span></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">Total de Institui√ß√µes: <span id="total-instituicoes">-</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar t√≠tulo do edital quando o ano de refer√™ncia mudar
            const anoReferenciaInput = document.getElementById('ano_referencia');
            const tituloInput = document.getElementById('titulo');
            
            if (anoReferenciaInput && tituloInput) {
                // Verificar se o t√≠tulo est√° vazio ou √© o padr√£o
                const tituloPadrao = tituloInput.value.startsWith('EDITAL DE ALISTAMENTO DE JURADOS PARA O ANO');
                
                anoReferenciaInput.addEventListener('input', function() {
                    // Se o t√≠tulo estiver vazio ou for o padr√£o, atualizar automaticamente
                    if (!tituloInput.value || tituloPadrao) {
                        const ano = this.value || (new Date().getFullYear() + 1);
                        tituloInput.value = 'EDITAL DE ALISTAMENTO DE JURADOS PARA O ANO ' + ano + ' DA COMARCA DE CAPIVARI DE BAIXO/SC';
                    }
                });
            }
            
            // Converter inputs para mai√∫sculas, exceto email, password, tel, url
            document.querySelectorAll('input[type="text"], input[type="search"], textarea').forEach(function(input) {
                if (input.type !== 'email' && input.type !== 'password' && input.type !== 'tel' && input.type !== 'url') {
                    input.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });

            // Fun√ß√£o para substituir placeholders no texto do edital
            async function substituirPlaceholders(mostrarConfirmacao = false) {
                const corpoRtf = document.getElementById('corpo_rtf');
                const anoReferencia = document.getElementById('ano_referencia').value;
                const juizSelect = document.getElementById('juiz_id');
                const nomeJuiz = juizSelect.options[juizSelect.selectedIndex].text;
                
                if (corpoRtf && corpoRtf.value) {
                    let conteudo = corpoRtf.value;
                    let alteracoesFeitas = false;
                    
                    // Verificar se h√° placeholders para substituir
                    const temPlaceholders = conteudo.includes('{ANO DE REFER√äNCIA}') || 
                                          conteudo.includes('{NOME DO JUIZ}') || 
                                          conteudo.includes('{DATA ATUAL POR EXTENSO}') ||
                                          conteudo.includes('{LISTA COM OS NOMES DOS JURADOS SEGUIDOS DA PROFISS√ÉO}');
                    
                    if (!temPlaceholders) {
                        if (mostrarConfirmacao) {
                            alert('N√£o h√° placeholders para substituir no texto atual.');
                        }
                        return;
                    }
                    
                    // Substituir placeholders
                    if (conteudo.includes('{ANO DE REFER√äNCIA}')) {
                        conteudo = conteudo.replace(/{ANO DE REFER√äNCIA}/g, anoReferencia || '');
                        alteracoesFeitas = true;
                    }
                    
                    if (conteudo.includes('{NOME DO JUIZ}')) {
                        const nomeJuizFinal = nomeJuiz !== 'Selecione um juiz...' ? nomeJuiz : '';
                        conteudo = conteudo.replace(/{NOME DO JUIZ}/g, nomeJuizFinal);
                        alteracoesFeitas = true;
                    }
                    
                    if (conteudo.includes('{DATA ATUAL POR EXTENSO}')) {
                        // Data atual por extenso (sem dia da semana) em MAI√öSCULAS
                        const dataAtual = new Date();
                        let dataPorExtenso = dataAtual.toLocaleDateString('pt-BR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        dataPorExtenso = dataPorExtenso.toUpperCase();
                        conteudo = conteudo.replace(/{DATA ATUAL POR EXTENSO}/g, dataPorExtenso);
                        alteracoesFeitas = true;
                    }
                    
                    // Substituir lista de jurados por lista de texto
                    if (conteudo.includes('{LISTA COM OS NOMES DOS JURADOS SEGUIDOS DA PROFISS√ÉO}')) {
                        try {
                            const response = await fetch('/editais/api/jurados-ativos');
                            const data = await response.json();
                            if (data.lista) {
                                conteudo = conteudo.replace(/{LISTA COM OS NOMES DOS JURADOS SEGUIDOS DA PROFISS√ÉO}/g, data.lista);
                                alteracoesFeitas = true;
                            }
                        } catch (error) {
                            console.error('Erro ao buscar lista de jurados:', error);
                            conteudo = conteudo.replace(/{LISTA COM OS NOMES DOS JURADOS SEGUIDOS DA PROFISS√ÉO}/g, 'Erro ao carregar lista de jurados.');
                            alteracoesFeitas = true;
                        }
                    }
                    
                    if (alteracoesFeitas) {
                        corpoRtf.value = conteudo;
                        
                        if (mostrarConfirmacao) {
                            alert('‚úÖ Placeholders substitu√≠dos com sucesso!');
                        }
                    }
                } else {
                    if (mostrarConfirmacao) {
                        alert('‚ö†Ô∏è Campo de conte√∫do do edital est√° vazio.');
                    }
                }
            }

            // Adicionar listener para o bot√£o "Atualizar Texto"
            document.getElementById('btn-atualizar-texto').addEventListener('click', function() {
                substituirPlaceholders(true);
            });

            // Fetch total de jurados e institui√ß√µes para o rodap√©
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-jurados').textContent = data.totalJurados;
                    document.getElementById('total-instituicoes').textContent = data.totalInstituicoes;
                })
                .catch(error => console.error('Erro ao buscar estat√≠sticas:', error));
        });
    </script>
</body>
</html>