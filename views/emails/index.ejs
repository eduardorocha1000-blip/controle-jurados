<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        body { height: 100vh; overflow: hidden; }
        .emails-scroll { height: calc(100vh - (var(--header-height) + var(--footer-height))); overflow-y: auto; }
        @media (max-width: 768px) { body { overflow: auto; height: auto; } .emails-scroll { height: auto; } }
    </style>
</head>
<body>
    <!-- Cabe√ßalho -->
    <header class="header-custom">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img src="/images/logo-tjsc.png" alt="Logo TJSC" class="header-logo">
                </div>
                <div class="col">
                    <h1 class="header-title">VARA √öNICA DA COMARCA DE CAPIVARI DE BAIXO</h1>
                    <p class="header-subtitle">by Eduardo Motta Rocha da Silva</p>
                </div>
                <div class="col-auto">
                    <% if (typeof user !== 'undefined' && user) { %>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            üë§ <%= user.nome %>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/perfil">‚öôÔ∏è Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="POST" action="/login/logout" class="d-inline">
                                    <button type="submit" class="dropdown-item">
                                        üö™ Sair
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar">
                <div class="p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">üìä Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/juizes">
                                ‚öñÔ∏è Ju√≠zes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/instituicoes">
                                üè¢ Institui√ß√µes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/jurados">
                                üë• Jurados
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/indicacoes">
                                üìã Indica√ß√µes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/sorteios">
                                üé≤ Sorteios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/ultimo-conselho">üôã √öltimo Conselho</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cedulas">üé´ C√©dulas</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/editais">üìÑ Editais</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/emails">üìß E-mails</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/relatorios">üìà Relat√≥rios</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/backup">
                                üíæ Backup
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/usuarios">
                                <i class="fas fa-user-cog btn-icon"></i>Usu√°rios
                            </a>
                        </li>
                    </ul>
                </div>
        </nav>

        <!-- Conte√∫do Principal -->
        <main class="main-content">
            <div class="container-fluid">
                <% if (typeof messages !== 'undefined' && messages) { %>
                    <% if (messages.success && messages.success.length > 0) { %>
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        ‚úÖ <%= messages.success[0] %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <% } %>
                    <% if (messages.error && messages.error.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        ‚ùå <%= messages.error[0] %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <% } %>
                <% } %>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Controle</h2>
                </div>

                <!-- Estat√≠sticas de E-mail -->
                <div class="row mb-4 stats-cards">
                    <div class="col-md-3 mb-3">
                        <div class="card card-stat h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-primary fs-5">üìß</div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title mb-0">Total Enviados</h5>
                                        <h3 class="mb-0"><%= typeof stats !== 'undefined' && stats ? stats.totalEnviados : 0 %></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card card-stat h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-success fs-5">üü¢</div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title mb-0">Enviados Hoje</h5>
                                        <h3 class="mb-0"><%= typeof stats !== 'undefined' && stats ? stats.enviadosHoje : 0 %></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card card-stat h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-danger fs-5">üî¥</div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title mb-0">Pendentes</h5>
                                        <h3 class="mb-0"><%= typeof stats !== 'undefined' && stats ? stats.pendentes : 0 %></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- A√ß√µes Principais -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-paper-plane btn-icon"></i>Enviar Intima√ß√µes
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Enviar intima√ß√£o para institui√ß√µes solicitando lista de cidad√£os exemplares.</p>
                                
                                <form id="intimacaoForm" method="POST" action="/emails/enviar-intimacao">
                                    <div class="mb-3">
                                        <label for="anoReferencia" class="form-label">Ano de Refer√™ncia <span class="text-danger">*</span></label>
                                        <select class="form-select" id="anoReferencia" name="ano_referencia" required>
                                            <option value="">Selecione o ano...</option>
                                            <% const anoAtual = new Date().getFullYear(); for(let ano = anoAtual; ano <= anoAtual + 5; ano++) { %>
                                                <option value="<%= ano %>" <%= typeof filtros !== 'undefined' && filtros.ano == ano ? 'selected' : '' %>><%= ano %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="instituicoes" class="form-label">Institui√ß√µes</label>
                                        <select class="form-select" id="instituicoes" name="instituicoes[]" multiple>
                                            <% if (typeof instituicoes !== 'undefined' && instituicoes) { %>
                                                <% instituicoes.forEach(instituicao => { %>
                                                    <option value="<%= instituicao.id %>"><%= instituicao.nome %></option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                        <div class="form-text">Selecione m√∫ltiplas institui√ß√µes ou deixe vazio para todas</div>
                                    </div>
                                    
                                    <!-- Campos removidos: Assunto e Mensagem Personalizada (conte√∫do vem do template salvo) -->
                                    
                                    <div class="d-flex flex-column align-items-center gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            ‚úàÔ∏è Enviar Intima√ß√µes
                                        </button>
                                        <button type="button" id="btnEnviarRecebimentos" class="btn btn-primary">
                                            üì© Enviar Recebimentos
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-cog btn-icon"></i>Configura√ß√µes de E-mail
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Configure as configura√ß√µes do servidor de e-mail e templates.</p>
                                
                                <form id="configForm" method="POST" action="/emails/configuracoes" onsubmit="return true;">
                                    <div class="mb-3">
                                        <label for="smtpHost" class="form-label">Servidor SMTP</label>
                                        <input type="text" class="form-control" id="smtpHost" name="smtp_host" value="<%= typeof config !== 'undefined' && config ? config.smtp_host : '' %>" data-keep-lowercase="true" style="text-transform: none !important;">
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="smtpPort" class="form-label">Porta</label>
                                            <input type="number" class="form-control" id="smtpPort" name="smtp_port" value="<%= typeof config !== 'undefined' && config ? config.smtp_port : '587' %>">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="smtpSecure" class="form-label">Seguro</label>
                                            <select class="form-select" id="smtpSecure" name="smtp_secure">
                                                <option value="false" <%= typeof config !== 'undefined' && config && !config.smtp_secure ? 'selected' : '' %>>N√£o</option>
                                                <option value="true" <%= typeof config !== 'undefined' && config && config.smtp_secure ? 'selected' : '' %>>Sim (TLS)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="smtpUser" class="form-label">Usu√°rio</label>
                                        <input type="email" class="form-control" id="smtpUser" name="smtp_user" value="<%= typeof config !== 'undefined' && config ? config.smtp_user : '' %>">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="smtpPass" class="form-label">Senha</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="smtpPass" name="smtp_pass" value="<%= typeof config !== 'undefined' && config ? config.smtp_pass : '' %>" data-keep-lowercase="true" style="text-transform: none !important;">
                                            <button class="btn btn-outline-secondary" type="button" id="togglePassword" title="Mostrar/Ocultar senha">
                                                <span id="togglePasswordIcon">üëÅÔ∏è</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="emailFrom" class="form-label">E-mail Remetente</label>
                                        <input type="email" class="form-control" id="emailFrom" name="email_from" value="<%= typeof config !== 'undefined' && config ? config.email_from : '' %>">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary btn-sm" id="btnSalvarConfigEmail" title="Salvar Configura√ß√µes">üíæ Salvar Configura√ß√µes</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Templates de E-mail -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt btn-icon"></i>Templates de E-mail
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-0">Template de Intima√ß√£o</h6>
                                            <p class="card-text mb-0">Template padr√£o para intima√ß√£o de institui√ß√µes.</p>
                                        </div>
                                        <button class="btn btn-edit btn-sm" onclick="editarTemplate('intimacao')" title="Editar">‚úèÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-0">Template de Confirma√ß√£o</h6>
                                            <p class="card-text mb-0">Template para confirma√ß√£o de recebimento.</p>
                                        </div>
                                        <button class="btn btn-edit btn-sm" onclick="editarTemplate('confirmacao')" title="Editar">‚úèÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controle de E-mails (Intima√ß√µes/Recebimentos) -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks btn-icon"></i>Controle
                        </h5>
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            <input type="text" id="filtroDestinatario" class="form-control form-control-sm" placeholder="Destinat√°rio" style="width: 250px;">
                            <input type="number" id="filtroAno" class="form-control form-control-sm" placeholder="Ano" min="2000" max="2099" style="width: 120px;">
                            <select id="filtroStatus" class="form-select form-select-sm" style="width: 150px;">
                                <option value="">Todos os status</option>
                                <option value="enviado">Enviado</option>
                                <option value="erro">Erro</option>
                            </select>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="chkIntimados" checked>
                                <label class="form-check-label" for="chkIntimados">Intimados</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="chkRecebidos" checked>
                                <label class="form-check-label" for="chkRecebidos">Recebidos</label>
                            </div>
                            <button class="btn btn-delete btn-sm" id="btnAtualizarControle" title="Atualizar">üîÑ</button>
                            <button class="btn btn-delete btn-sm" id="btnApagarHistorico" title="Apagar Hist√≥rico">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelaControle">
                                <thead>
                                    <tr>
                                        <th>Data de Envio</th>
                                        <th>Destinat√°rio</th>
                                        <th>Assunto</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-center">Tipo</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="controleVazio" class="text-center text-muted d-none">Nenhum e-mail encontrado</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Rodap√© -->
    <footer class="footer-custom">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">Total de Jurados: <span id="total-jurados">-</span></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">Total de Institui√ß√µes: <span id="total-instituicoes">-</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/table-sort.js"></script>
    <script>
        // Definir baseUrl correto (sempre HTTP para localhost)
        const baseUrl = window.location.protocol === 'https:' 
            ? 'http://' + window.location.host 
            : window.location.origin;
        
        // Fun√ß√µes JavaScript
        function editarTemplate(tipo) {
            window.open(baseUrl + `/emails/template/${tipo}`, '_blank');
        }

        function visualizarEmail(id) {
            window.open(baseUrl + `/emails/visualizar/${id}`, '_blank');
        }

        function reenviarEmail(id) {
            fetch(baseUrl + `/emails/reenviar/${id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('E-mail reenviado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao reenviar e-mail: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao reenviar e-mail: ' + error.message);
            });
        }

        function excluirEmail(id) {
            fetch(baseUrl + `/emails/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('E-mail exclu√≠do com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao excluir e-mail: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao excluir e-mail: ' + error.message);
            });
        }

        function atualizarHistorico() {
            location.reload();
        }

        function limparHistorico() {
            fetch(baseUrl + '/emails/limpar-historico', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Hist√≥rico limpo com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao limpar hist√≥rico: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao limpar hist√≥rico: ' + error.message);
            });
        }

        // Carregar totais no rodap√©
        fetch(baseUrl + '/api/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-jurados').textContent = data.totalJurados || 0;
                document.getElementById('total-instituicoes').textContent = data.totalInstituicoes || 0;
            })
            .catch(error => console.error('Erro ao carregar estat√≠sticas:', error));

        // Inicializar quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Remover qualquer listener de convers√£o para mai√∫sculas do campo SMTP
            const smtpHostField = document.getElementById('smtpHost');
            if (smtpHostField) {
                // Aguardar um pouco para garantir que o c√≥digo do layout j√° foi executado
                setTimeout(function() {
                    // Clonar o campo para remover todos os event listeners
                    const newField = smtpHostField.cloneNode(true);
                    newField.setAttribute('data-keep-lowercase', 'true');
                    newField.style.textTransform = 'none';
                    smtpHostField.parentNode.replaceChild(newField, smtpHostField);
                    
                    // Adicionar listener que preserva o texto original
                    newField.addEventListener('input', function(e) {
                        const originalValue = this.value;
                        // Se o valor foi convertido para mai√∫sculas, restaurar
                        setTimeout(() => {
                            if (this.value !== originalValue && this.value === originalValue.toUpperCase()) {
                                this.value = originalValue;
                            }
                        }, 0);
                    });
                }, 100);
            }
            
            // Proteger campo de senha SMTP de convers√£o para mai√∫sculas e adicionar toggle
            const smtpPassField = document.getElementById('smtpPass');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const togglePasswordIcon = document.getElementById('togglePasswordIcon');
            
            if (smtpPassField) {
                // Garantir que o campo de senha n√£o seja convertido
                smtpPassField.setAttribute('data-keep-lowercase', 'true');
                smtpPassField.style.textTransform = 'none';
                
                // Adicionar listener que preserva o texto original
                smtpPassField.addEventListener('input', function(e) {
                    const originalValue = this.value;
                    // Se o valor foi convertido para mai√∫sculas, restaurar
                    setTimeout(() => {
                        if (this.value !== originalValue && this.value === originalValue.toUpperCase()) {
                            this.value = originalValue;
                        }
                    }, 0);
                });
                
                // Bot√£o para mostrar/ocultar senha
                if (togglePasswordBtn && togglePasswordIcon) {
                    togglePasswordBtn.addEventListener('click', function() {
                        if (smtpPassField.type === 'password') {
                            smtpPassField.type = 'text';
                            togglePasswordIcon.textContent = 'üôà';
                        } else {
                            smtpPassField.type = 'password';
                            togglePasswordIcon.textContent = 'üëÅÔ∏è';
                        }
                    });
                }
            }
            
            // Feedback visual para formul√°rio de intima√ß√£o
            const intimacaoForm = document.getElementById('intimacaoForm');
            if (intimacaoForm) {
                intimacaoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('[Frontend] Formul√°rio de intima√ß√£o submetido');
                    
                    // Validar campos antes de enviar
                    const anoReferencia = document.getElementById('anoReferencia');
                    if (!anoReferencia || !anoReferencia.value) {
                        alert('‚ùå Por favor, selecione o ano de refer√™ncia.');
                        return;
                    }
                    
            const btn = this.querySelector('button[type="submit"]');
                    const btnOriginalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i>Enviando...';
            btn.disabled = true;
                    
                    // Criar objeto com dados do formul√°rio
                    const formDataObj = new FormData(this);
                    const data = {};
                    
                    // Converter FormData para objeto
                    for (let [key, value] of formDataObj.entries()) {
                        if (key === 'instituicoes[]') {
                            // Se for array de institui√ß√µes
                            if (!data.instituicoes) {
                                data.instituicoes = [];
                            }
                            data.instituicoes.push(value);
                        } else {
                            data[key] = value;
                        }
                    }
                    
                    // Log dos dados que ser√£o enviados
                    console.log('[Frontend] Dados que ser√£o enviados:', data);
                    
                    // Enviar como URL-encoded (mais compat√≠vel com Express)
                    const urlEncodedData = new URLSearchParams();
                    Object.keys(data).forEach(key => {
                        if (Array.isArray(data[key])) {
                            data[key].forEach(val => {
                                urlEncodedData.append('instituicoes', val);
                            });
                        } else {
                            urlEncodedData.append(key, data[key]);
                        }
                    });
                    
                    console.log('[Frontend] Enviando requisi√ß√£o para /emails/enviar-intimacao');
                    
                    fetch(baseUrl + '/emails/enviar-intimacao', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData.toString()
                    })
                    .then(response => {
                        console.log('[Frontend] Resposta recebida:', response.status);
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[Frontend] Dados recebidos:', data);
                        btn.innerHTML = btnOriginalHTML;
                        btn.disabled = false;
                        
                        if (data.success) {
                            alert('‚úÖ ' + data.message);
                        } else {
                            let errorMsg = '‚ùå ' + (data.message || 'Erro ao enviar intima√ß√µes');
                            if (data.detalhes && data.detalhes.length > 0) {
                                const erros = data.detalhes.filter(d => d.includes('Erro') || d.includes('erro'));
                                if (erros.length > 0) {
                                    errorMsg += '\n\nüîç Detalhes dos erros:\n\n';
                                    erros.forEach((erro, index) => {
                                        errorMsg += `${index + 1}. ${erro}\n`;
                                    });
                                } else {
                                    errorMsg += '\n\nüîç Detalhes:\n\n';
                                    data.detalhes.forEach((detalhe, index) => {
                                        errorMsg += `${index + 1}. ${detalhe}\n`;
                                    });
                                }
                            }
                            alert(errorMsg);
                        }
                        
                        // Recarregar a p√°gina para atualizar o hist√≥rico
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('[Frontend] Erro ao enviar:', error);
                        btn.innerHTML = btnOriginalHTML;
                        btn.disabled = false;
                        alert('‚ùå Erro ao enviar: ' + (error.message || 'Erro desconhecido') + '\n\nVerifique o console do navegador (F12) para mais detalhes.');
        });
                });

                // Bot√£o: Enviar Recebimentos (usa os mesmos dados do formul√°rio)
                const btnReceb = document.getElementById('btnEnviarRecebimentos');
                if (btnReceb) {
                    btnReceb.addEventListener('click', function() {
                        // Validar ano
                        const anoReferencia = document.getElementById('anoReferencia');
                        if (!anoReferencia || !anoReferencia.value) {
                            alert('‚ùå Por favor, selecione o ano de refer√™ncia.');
                            return;
                        }

                        // Coletar dados do formul√°rio
                        const formDataObj = new FormData(intimacaoForm);
                        const data = {};
                        for (let [key, value] of formDataObj.entries()) {
                            if (key === 'instituicoes[]') {
                                if (!data.instituicoes) data.instituicoes = [];
                                data.instituicoes.push(value);
                            } else {
                                data[key] = value;
                            }
                        }

                        // Montar URL-encoded
                        const urlEncodedData = new URLSearchParams();
                        Object.keys(data).forEach(key => {
                            if (Array.isArray(data[key])) {
                                data[key].forEach(val => urlEncodedData.append('instituicoes', val));
                            } else {
                                urlEncodedData.append(key, data[key]);
                            }
                        });

                        // Feedback
                        const original = btnReceb.innerHTML;
                        btnReceb.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i>Enviando...';
                        btnReceb.disabled = true;

                        fetch(baseUrl + '/emails/enviar-recebimentos', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: urlEncodedData.toString()
                        })
                        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                        .then(data => {
                            alert((data.success ? '‚úÖ ' : '‚ùå ') + (data.message || 'Opera√ß√£o conclu√≠da'));
                            setTimeout(() => window.location.reload(), 1500);
                        })
                        .catch(err => alert('‚ùå Erro ao enviar recebimentos: ' + (err.message || err)))
                        .finally(() => { btnReceb.innerHTML = original; btnReceb.disabled = false; });
                    });
                }
            } else {
                console.error('[Frontend] Formul√°rio intimacaoForm n√£o encontrado!');
            }
            
            // GARANTIR que o formul√°rio de configura√ß√µes N√ÉO √© interceptado
            // N√£o adicionar nenhum listener ao configForm - deixar submit completamente normal

        // Inicializar select m√∫ltiplo
            const instituicoesSelect = document.getElementById('instituicoes');
            if (instituicoesSelect) {
                // Adicionar op√ß√£o "Selecionar Todas"
                const optionTodas = document.createElement('option');
                optionTodas.value = 'todas';
                optionTodas.textContent = 'Selecionar Todas';
                instituicoesSelect.insertBefore(optionTodas, instituicoesSelect.firstChild);
                
                // L√≥gica para selecionar todas
                instituicoesSelect.addEventListener('change', function() {
                    if (this.value === 'todas') {
                        Array.from(this.options).forEach(option => {
                            if (option.value !== 'todas') {
                                option.selected = true;
                            }
                        });
                    }
                });
            }

            // =====================
            // Painel Controle de E-mails (AJAX)
            // =====================
            function renderControle(rows){
                const tbody = document.querySelector('#tabelaControle tbody');
                const vazio = document.getElementById('controleVazio');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!rows || rows.length === 0){
                    if (vazio) vazio.classList.remove('d-none');
                    return;
                }
                if (vazio) vazio.classList.add('d-none');
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.data_envio}</td>
                        <td>${row.destinatario}</td>
                        <td>${row.assunto}</td>
                        <td class="text-center"><span class="badge ${row.status==='erro'?'bg-danger':'bg-success'}">${row.status}</span></td>
                        <td class="text-center"><span class="badge ${row.tipo==='Recebido'?'bg-primary':'bg-warning text-dark'}">${row.tipo}</span></td>
                        <td>
                            <a href="#" class="btn btn-view btn-sm" title="Visualizar" onclick="visualizarEmail('${row.id}'); return false;">üëÅÔ∏è</a>
                            <a href="#" class="btn btn-edit btn-sm" title="Reenviar" onclick="reenviarEmail('${row.id}'); return false;">üîÅ</a>
                            <button class="btn btn-delete btn-sm" title="Excluir" onclick="excluirEmail('${row.id}')">üóëÔ∏è</button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            function carregarControle(){
                const tipo = document.getElementById('filtroTipo')?.value || '';
                const status = document.getElementById('filtroStatus')?.value || '';
                const params = new URLSearchParams();
                const destinatario = document.getElementById('filtroDestinatario')?.value || '';
                const ano = document.getElementById('filtroAno')?.value || '';
                const mostrarIntimados = document.getElementById('chkIntimados')?.checked !== false;
                const mostrarRecebidos = document.getElementById('chkRecebidos')?.checked !== false;
                if (status) params.append('status', status);
                if (destinatario) params.append('destinatario', destinatario);
                if (ano) params.append('ano', ano);
                params.append('mostrar_intimados', mostrarIntimados ? '1' : '0');
                params.append('mostrar_recebidos', mostrarRecebidos ? '1' : '0');
                fetch(baseUrl + '/emails/controle?' + params.toString())
                  .then(r => r.json())
                  .then(d => { if (d && d.success) renderControle(d.data); })
                  .catch(() => {});
            }
            document.getElementById('btnAtualizarControle')?.addEventListener('click', carregarControle);
            document.getElementById('btnApagarHistorico')?.addEventListener('click', function(){
                fetch(baseUrl + '/emails/limpar-historico', { method: 'POST' })
                  .then(r => r.json())
                  .then(d => {
                    alert((d.success ? '‚úÖ ' : '‚ùå ') + (d.message || 'Opera√ß√£o conclu√≠da'));
                    carregarControle();
                  })
                  .catch(err => alert('‚ùå Erro ao limpar hist√≥rico: ' + (err.message || err)));
            });
            document.getElementById('filtroDestinatario')?.addEventListener('input', (e)=>{ if(e.target.value.length===0) carregarControle(); });
            document.getElementById('filtroAno')?.addEventListener('input', (e)=>{ if(e.target.value.length===0 || e.target.value.length===4) carregarControle(); });
            document.getElementById('filtroStatus')?.addEventListener('change', carregarControle);
            document.getElementById('chkIntimados')?.addEventListener('change', carregarControle);
            document.getElementById('chkRecebidos')?.addEventListener('change', carregarControle);
            carregarControle();
        });
    </script>
</body>
</html>
